<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Tareas — iOS style</title>
  <meta name="theme-color" content="#007aff" />
  <style>
    :root{
      --blue:#007aff; --bg:#ffffff; --card:#ffffff; --ink:#0a0a0a; --muted:#6b7280;
      --shadow:0 8px 20px rgba(0,0,0,.05); --radius:18px; --gutter:14px;
      --red:#ef4444; --yellow:#f59e0b; --green:#22c55e;
      --red-soft:#fee2e2; --yellow-soft:#fef3c7; --green-soft:#dcfce7;
    }
    html,body{height:100%}
    body{margin:0; background:var(--bg); color:var(--ink);
      font:16px/1.4 -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Ubuntu,"Helvetica Neue",Arial,sans-serif;
      -webkit-font-smoothing:antialiased; text-rendering:optimizeLegibility}
    header{position:sticky; top:0; z-index:10; background:rgba(255,255,255,.85);
      backdrop-filter:saturate(180%) blur(12px); border-bottom:1px solid rgba(0,0,0,.06)}
    .container{max-width:820px; margin:0 auto; padding:16px clamp(8px, 4vw, 20px)}
    .titlebar{display:flex; align-items:center; gap:10px; flex-wrap:wrap}
    .app-title{font-weight:700; letter-spacing:.2px; font-size:22px}
    .pill{margin-left:auto; font-size:12px; color:#245; background:#eef6ff; padding:6px 10px; border-radius:999px; border:1px solid #d6e9ff}

    /* Sync bar */
    .sync{display:flex; gap:8px; align-items:center; margin-top:8px; flex-wrap:wrap}
    .sync input{height:40px; border-radius:999px; border:1px solid #e5e7eb; padding:0 14px; box-shadow:var(--shadow)}
    .sync .btn{height:40px; padding:0 14px}

    /* Composer */
    .composer{display:grid; grid-template-columns: 1fr minmax(150px, 210px) auto; gap:10px; align-items:center; margin-top:12px}
    .field, .date{height:44px; border-radius:999px; border:1px solid #e5e7eb; background:#fff; box-shadow:var(--shadow)}
    .field{padding:0 16px; display:flex; align-items:center}
    .field input{border:0; outline:0; font-size:16px; width:100%; background:transparent}
    .date{padding:0 14px; color:var(--ink); display:flex; align-items:center}
    .date input{border:0; outline:0; font-size:15px; width:100%; background:transparent; color:inherit; accent-color:var(--blue)}
    .btn{height:44px; padding:0 18px; border:0; border-radius:12px; background:var(--blue);
      color:#fff; font-weight:600; letter-spacing:.2px; cursor:pointer; box-shadow:0 8px 20px rgba(0,122,255,.25);
      transition:transform .06s ease, filter .06s ease; white-space:nowrap}
    .btn:active{transform:translateY(1px); filter:saturate(1.1)}

    /* List */
    .list-wrap{margin-top:18px; padding-inline:var(--gutter)} /* espacio lateral en mobile */
    ul#taskList{list-style:none; margin:0; padding:0; display:grid; gap:10px}

    .item{display:grid; grid-template-columns: 28px 1fr auto; align-items:center; gap:12px;
      background:var(--card); border:1px solid #ececec; box-shadow:var(--shadow);
      padding:12px; border-radius:var(--radius); content-visibility:auto; contain:content;}
    .item.dragging{opacity:.9}
    .handle{width:28px; height:28px; display:grid; place-items:center; cursor:grab; user-select:none; touch-action:none}
    .dots{width:14px; height:14px; background:radial-gradient(currentColor 1px, transparent 2px); background-size:6px 6px; background-position:0 0, 3px 3px; color:#c1c7d0}
    .main{display:grid; gap:4px}
    .title{font-weight:600; line-height:1.2}
    .meta{font-size:12px; color:var(--muted)}

    .badge{font-size:12px; font-weight:700; padding:6px 10px; border-radius:999px; border:1px solid transparent}
    .badge.red{background:var(--red-soft); color:var(--red); border-color:#fecaca}
    .badge.yellow{background:var(--yellow-soft); color:var(--yellow); border-color:#fde68a}
    .badge.green{background:var(--green-soft); color:var(--green); border-color:#bbf7d0}

    .actions{display:flex; align-items:center; gap:8px}
    .icon-btn{height:36px; width:36px; border:1px solid #e5e7eb; background:#fff; border-radius:12px; display:grid; place-items:center; cursor:pointer}
    .icon-btn:active{transform:translateY(1px)}
    .check{accent-color:var(--blue); width:18px; height:18px}

    /* Completed */
    details.completed{margin-top:24px; padding-inline:var(--gutter)}
    details summary{cursor:pointer; user-select:none; font-weight:600}
    .done .title{text-decoration:line-through; color:#9ca3af}
    .done .badge{opacity:.35}

    @media (max-width:560px){
      .composer{grid-template-columns: 1fr auto; grid-template-rows:auto auto}
      .composer .date{grid-column:1/3}
      .list-wrap{padding-inline: max(var(--gutter), 10px)}
      .item{padding:12px clamp(8px, 3vw, 14px)}
    }
    @media (prefers-reduced-motion: reduce){
      .item,.btn{transition:none}
    }
  </style>
</head>
<body>
  <header>
    <div class="container">
      <div class="titlebar">
        <div class="app-title">Tareas</div>
        <span class="pill" id="stats">0 pendientes</span>
      </div>
      <div class="sync">
        <input id="syncKey" placeholder="Código de sincronización (opcional)" />
        <button class="btn" id="useKey" type="button">Usar código</button>
        <button class="btn" id="unlink" type="button" style="background:#ef4444">Desvincular</button>
        <button class="btn" id="syncNow" type="button" style="background:#10b981">Sincronizar</button>
      </div>
      <form id="composer" class="composer" autocomplete="off">
        <div class="field"><input id="taskText" type="text" placeholder="Escribe y presiona Enter" required /></div>
        <div class="date"><input id="taskDate" type="date" /></div>
        <button class="btn" type="submit" aria-label="Agregar">Agregar</button>
      </form>
    </div>
  </header>

  <main class="container">
    <div class="list-wrap">
      <ul id="taskList" aria-live="polite"></ul>
    </div>

    <details class="completed" id="completedBox">
      <summary>Completadas <span id="doneCount" style="opacity:.6">(0)</span></summary>
      <ul id="doneList" style="list-style:none; margin:10px 0 0; padding:0; display:grid; gap:8px"></ul>
      <div style="margin-top:10px; display:flex; gap:8px; flex-wrap:wrap">
        <button class="btn" id="clearDone" type="button" style="background:#0ea5e9">Limpiar completadas</button>
        <button class="btn" id="exportAll" type="button" title="Exportar JSON" style="background:#10b981">Exportar</button>
        <input id="importFile" type="file" accept="application/json" style="display:none" />
        <button class="btn" id="importBtn" type="button" title="Importar" style="background:#6b7280">Importar</button>
      </div>
    </details>
  </main>

  <script>
  (function(){
    const $ = sel => document.querySelector(sel);
    const taskList = $('#taskList');
    const doneList = $('#doneList');
    const stats = $('#stats');
    const doneCount = $('#doneCount');
    const text = $('#taskText');
    const date = $('#taskDate');
    const syncKeyInput = $('#syncKey');
    const useKeyBtn = $('#useKey');
    const unlinkBtn = $('#unlink');
    const syncNowBtn = $('#syncNow');

    // Default fecha: mañana
    const tomorrow = new Date(); tomorrow.setDate(tomorrow.getDate()+1);
    date.value = toInputDate(tomorrow);

    const storeKey = 'taskbox.v2';
    let tasks = load();

    function uid(){return Math.random().toString(36).slice(2,9)}
    function toInputDate(d){return d.toISOString().slice(0,10)}
    function startOfDay(d){return new Date(d.getFullYear(), d.getMonth(), d.getDate())}
    function daysLeftStr(dueStr){
      if(!dueStr) return {text:'Sin fecha', cls:'yellow'};
      const now = new Date();
      const today = startOfDay(now);
      const due = startOfDay(new Date(dueStr));
      const diffDays = Math.round((due - today) / 86400000);
      if(diffDays < 0) return {text:\`Vencida \${Math.abs(diffDays)} d\`, cls:'red'};
      if(diffDays === 0) return {text:'Hoy', cls:'red'};
      if(diffDays === 1) return {text:'Mañana', cls:'red'};
      if(diffDays === 2 || diffDays === 3) return {text:\`Faltan \${diffDays} d\`, cls:'yellow'};
      return {text:\`Faltan \${diffDays} d\`, cls:'green'};
    }
    function save(){localStorage.setItem(storeKey, JSON.stringify(tasks))}
    function load(){try{ return JSON.parse(localStorage.getItem(storeKey)||'[]') }catch{ return [] }}
    function render(){
      const fragPending = document.createDocumentFragment();
      const fragDone = document.createDocumentFragment();
      taskList.innerHTML = ''; doneList.innerHTML='';
      const pending = tasks.filter(t=>!t.done).sort((a,b)=>a.order-b.order);
      const done = tasks.filter(t=>t.done).sort((a,b)=>b.created-a.created);
      pending.forEach(t=> fragPending.appendChild(renderItem(t)) );
      done.forEach(t=> fragDone.appendChild(renderItem(t,true)) );
      taskList.appendChild(fragPending); doneList.appendChild(fragDone);
      stats.textContent = \`\${pending.length} pendientes\`; doneCount.textContent = \`(\${done.length})\`;
    }
    function renderItem(t, isDone=false){
      const li = document.createElement('li');
      li.className = 'item'+(isDone?' done':''); li.dataset.id = t.id;
      li.innerHTML = \`
        <div class="handle" title="Arrastrar"><div class="dots" aria-hidden="true"></div></div>
        <div class="main">
          <div class="title" contenteditable="true" spellcheck="false"></div>
          <div class="meta"><span class="badge" id="b-\${t.id}"></span></div>
        </div>
        <div class="actions">
          <input class="check" type="checkbox" \${t.done?'checked':''} title="Marcar" />
          <button class="icon-btn" title="Cambiar fecha" aria-label="Cambiar fecha">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><rect x="3" y="4" width="18" height="18" rx="3"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
          </button>
          <button class="icon-btn" title="Eliminar" aria-label="Eliminar">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"/><path d="M10 11v6"/><path d="M14 11v6"/><path d="M9 6V4a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2v2"/></svg>
          </button>
        </div>\`;
      li.querySelector('.title').textContent = t.title;
      applyBadge(t);
      return li;
    }
    function applyBadge(t){
      const b = document.getElementById('b-'+t.id); if(!b) return;
      const {text, cls} = daysLeftStr(t.due);
      b.textContent = text; b.className = 'badge '+cls;
    }

    // ---- Delegación de eventos ----
    taskList.addEventListener('click', (e)=>{
      const li = e.target.closest('.item'); if(!li) return;
      const id = li.dataset.id; const t = tasks.find(x=>x.id===id); if(!t) return;
      if(e.target.closest('.icon-btn')){
        const buttons = li.querySelectorAll('.icon-btn');
        if(e.target.closest('.icon-btn') === buttons[0]){
          const tmp = document.createElement('input');
          tmp.type = 'date'; tmp.style.position='fixed'; tmp.style.opacity='0';
          if(t.due) tmp.value = t.due; document.body.appendChild(tmp); tmp.focus(); tmp.showPicker?.();
          tmp.addEventListener('change', ()=>{ t.due = tmp.value; save(); applyBadge(t); queueSaveCloud(); });
          tmp.addEventListener('blur', ()=> tmp.remove());
        } else {
          tasks = tasks.filter(x=>x.id!==t.id); save(); render(); queueSaveCloud();
        }
      }
    });
    taskList.addEventListener('change', (e)=>{
      const li = e.target.closest('.item'); if(!li) return;
      const id = li.dataset.id; const t = tasks.find(x=>x.id===id); if(!t) return;
      if(e.target.matches('.check')){ t.done = e.target.checked; save(); render(); queueSaveCloud(); }
    });
    taskList.addEventListener('focusout', (e)=>{
      if(!e.target.classList.contains('title')) return;
      const li = e.target.closest('.item'); const t = tasks.find(x=>x.id===li.dataset.id); if(!t) return;
      const v = e.target.textContent.trim(); if(!v){ e.target.textContent = t.title; return; }
      t.title = v; save(); queueSaveCloud();
    });
    taskList.addEventListener('keydown', (e)=>{
      if(e.target.classList.contains('title') && e.key==='Enter'){ e.preventDefault(); e.target.blur(); }
    });

    // Composer
    $('#composer').addEventListener('submit', (e)=>{
      e.preventDefault();
      const title = text.value.trim(); if(!title) return;
      const due = date.value || '';
      const maxOrder = tasks.filter(t=>!t.done).reduce((m,t)=>Math.max(m,t.order), -1) + 1;
      const t = {id:uid(), title, due, done:false, order:maxOrder, created:Date.now()};
      tasks.push(t); save();
      text.value = ''; text.focus();
      const li = renderItem(t); taskList.appendChild(li);
      applyBadge(t); stats.textContent = \`\${[...taskList.children].length} pendientes\`;
      queueSaveCloud();
    });

    // ---- Drag & drop SIN librerías (pointer events) ----
    let drag = null;
    taskList.addEventListener('pointerdown', (e)=>{
      const handle = e.target.closest('.handle'); if(!handle) return;
      const li = handle.closest('.item'); if(!li) return;
      e.preventDefault();
      startDrag(li, e);
    });

    function startDrag(li, e){
      const rect = li.getBoundingClientRect();
      const placeholder = document.createElement('li');
      placeholder.className = 'item';
      placeholder.style.height = rect.height + 'px';
      placeholder.style.border = '2px dashed #cbd5e1';
      li.parentNode.insertBefore(placeholder, li);
      li.classList.add('dragging');
      // Absolute drag ghost
      const ghost = li;
      const startY = e.clientY;
      let offsetY = 0;

      const onMove = (ev)=>{
        offsetY = ev.clientY - startY;
        // Detect swap
        const siblings = [...taskList.children].filter(x=>x!==ghost);
        // find index for insertion by center comparisons
        for(const sib of siblings){
          const r = sib.getBoundingClientRect();
          const midpoint = r.top + r.height/2;
          if(ev.clientY < midpoint){
            taskList.insertBefore(placeholder, sib);
            break;
          }
          if(sib===siblings[siblings.length-1]){
            taskList.appendChild(placeholder);
          }
        }
      };
      const onUp = ()=>{
        ghost.classList.remove('dragging');
        taskList.insertBefore(ghost, placeholder);
        placeholder.remove();
        window.removeEventListener('pointermove', onMove);
        window.removeEventListener('pointerup', onUp, true);
        resyncOrdersFromDOM(); queueSaveCloud();
      };

      window.addEventListener('pointermove', onMove);
      window.addEventListener('pointerup', onUp, true);
    }

    function resyncOrdersFromDOM(){
      [...taskList.children].forEach((li, idx)=>{
        const id = li.dataset.id;
        const t = tasks.find(x=>x.id===id);
        if(t){t.order = idx}
      });
      save();
    }

    // ---- Sync en la nube (Netlify Functions + Blobs) ----
    const API = '/api/tasks';
    function getKey(){ return localStorage.getItem('syncKey') || '' }
    function setKey(k){ if(k){ localStorage.setItem('syncKey', k); } else { localStorage.removeItem('syncKey'); } syncKeyInput.value = k || ''; }
    syncKeyInput.value = getKey();

    useKeyBtn.onclick = async ()=>{
      const k = syncKeyInput.value.trim();
      if(!k) return;
      setKey(k);
      await loadFromCloud(k);
    };
    unlinkBtn.onclick = ()=> setKey('');
    syncNowBtn.onclick = ()=> saveToCloud(getKey(), true);

    async function loadFromCloud(k){
      try{
        const r = await fetch(\`\${API}?key=\${encodeURIComponent(k)}\`, { headers:{'cache-control':'no-cache'} });
        if(!r.ok) throw new Error('No se pudo cargar');
        const data = await r.json();
        if(Array.isArray(data.tasks)){
          tasks = data.tasks.map((t,i)=> ({...t, order: (typeof t.order==='number')? t.order : i}));
          save(); render();
        }
      }catch(err){ console.warn('Sync GET:', err.message); }
    }

    let saveTimer = null;
    function queueSaveCloud(){
      const k = getKey(); if(!k) return;
      clearTimeout(saveTimer);
      saveTimer = setTimeout(()=> saveToCloud(k), 700);
    }
    async function saveToCloud(k, force=false){
      if(!k) return;
      try{
        await fetch(API, {
          method:'POST',
          headers:{'content-type':'application/json'},
          body: JSON.stringify({ key:k, tasks })
        });
        if(force) console.log('Sincronizado');
      }catch(err){ console.warn('Sync POST:', err.message); }
    }

    // Import / export
    $('#exportAll').addEventListener('click', ()=>{
      const blob = new Blob([JSON.stringify(tasks,null,2)], {type:'application/json'});
      const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
      a.download = 'tareas.json'; a.click(); URL.revokeObjectURL(a.href);
    });
    $('#importBtn').addEventListener('click', ()=> $('#importFile').click());
    $('#importFile').addEventListener('change', (e)=>{
      const f = e.target.files?.[0]; if(!f) return;
      const r = new FileReader();
      r.onload = ()=>{
        try{
          const data = JSON.parse(r.result);
          if(Array.isArray(data)) { tasks = data; save(); render(); queueSaveCloud(); }
          else if(data && Array.isArray(data.tasks)) { tasks = data.tasks; save(); render(); queueSaveCloud(); }
        }catch{ alert('Archivo inválido'); }
      };
      r.readAsText(f);
    });

    $('#clearDone').addEventListener('click', ()=>{
      tasks = tasks.filter(t=>!t.done); save(); render(); queueSaveCloud();
    });

    // Primera carga
    tasks.sort((a,b)=> (a.order??0) - (b.order??0));
    tasks = tasks.map((t,i)=> ({...t, order: (typeof t.order==='number')? t.order : i}));
    save();
    render();
    if(getKey()) loadFromCloud(getKey());
  })();
  </script>
</body>
</html>
